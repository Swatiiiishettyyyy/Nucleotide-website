# Alembic Migrations

This directory contains Alembic database migration scripts for the Nucleotide-web project.

## Overview

All database schema changes are managed through Alembic migrations. The old custom migration system (`database_migrations.py`) has been deprecated in favor of this cleaner, version-controlled approach.

## Migration Scripts

All migration scripts are located in `alembic/versions/` and follow a naming convention:
- `001_initial_schema.py` - Base schema (placeholder)
- `002_add_categories_and_product_category.py` - Categories table and product category_id
- `003_add_member_fields.py` - Member dob and associated_category_id
- `004_add_order_item_status_tracking.py` - Per-item status tracking for orders
- `005_fix_order_foreign_keys.py` - Foreign key constraint fixes
- `006_add_audit_log_identifying_columns.py` - Audit log identifying columns
- `007_add_device_session_columns.py` - Device session enhancements

Each migration script includes:
- **Tags**: Logical grouping (e.g., `categories`, `orders`, `audit`)
- **Revision ID**: Unique identifier for the migration
- **Upgrade/Downgrade**: Forward and rollback operations

## Running Migrations

### Automatic (Recommended)
Migrations run automatically on application startup via `alembic_runner.py`.

### Manual
You can also run migrations manually:

```bash
# Upgrade to latest version
alembic upgrade head

# Upgrade to specific revision
alembic upgrade 007_device_sessions

# Downgrade one revision
alembic downgrade -1

# Show current revision
alembic current

# Show migration history
alembic history

# Show pending migrations
alembic heads
```

## Creating New Migrations

### Auto-generate (Recommended)
```bash
# Auto-generate migration from model changes
alembic revision --autogenerate -m "description_of_changes"

# With tags
alembic revision --autogenerate -m "add_user_preferences" --tag=users
```

### Manual
```bash
# Create empty migration template
alembic revision -m "description_of_changes"
```

## Migration Tags

Tags help organize migrations by feature area:
- `schema` - Base schema changes
- `categories` - Category-related changes
- `products` - Product-related changes
- `members` - Member-related changes
- `orders` - Order-related changes
- `status_tracking` - Status tracking features
- `foreign_keys` - Foreign key constraint changes
- `audit` - Audit logging features
- `sessions` - Session management
- `authentication` - Authentication features

## Best Practices

1. **Always test migrations** on a development database first
2. **Keep migrations small and focused** - one logical change per migration
3. **Use descriptive names** - migration names should clearly describe what they do
4. **Include data migrations** when schema changes require data backfilling
5. **Test downgrade paths** - ensure migrations can be rolled back
6. **Review autogenerated migrations** - always review and adjust auto-generated code

## Troubleshooting

### Migration fails
1. Check database connection in `alembic.ini` and `.env`
2. Verify all model imports in `alembic/env.py`
3. Check for conflicting migrations: `alembic history`
4. Review error logs for specific SQL errors

### Migration already applied
If a migration shows as already applied but changes aren't present:
```bash
# Stamp the database with current revision (use with caution)
alembic stamp head
```

### Rollback
```bash
# Rollback to previous revision
alembic downgrade -1

# Rollback to specific revision
alembic downgrade 003_member_fields
```

## Configuration

- **alembic.ini**: Main Alembic configuration
- **alembic/env.py**: Migration environment setup and model imports
- **alembic/script.py.mako**: Migration template

## Deprecated System

The old `database_migrations.py` file is kept for reference but is **deprecated**. 
All new migrations should use Alembic.

