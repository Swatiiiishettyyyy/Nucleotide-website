# Database Migration Guide

## Overview

The project has been migrated from a custom migration system (`database_migrations.py`) to **Alembic**, a standard database migration tool for SQLAlchemy. This provides:

- ✅ Clean, version-controlled migration scripts
- ✅ Proper tagging and organization
- ✅ Rollback capabilities
- ✅ Better collaboration and code review
- ✅ Industry-standard tooling

## What Changed

### Before
- Custom migration functions in `database_migrations.py`
- No version control for schema changes
- Difficult to track migration history
- No rollback capabilities

### After
- Alembic migration scripts in `alembic/versions/`
- Version-controlled migrations with proper tags
- Easy rollback with `alembic downgrade`
- Clear migration history

## Migration Scripts

All migrations are located in `alembic/versions/`:

1. **001_initial_schema.py** - Base schema placeholder
2. **002_add_categories_and_product_category.py** - Categories and product category support
3. **003_add_member_fields.py** - Member dob and category association
4. **004_add_order_item_status_tracking.py** - Per-item order status tracking
5. **005_fix_order_foreign_keys.py** - Foreign key constraint fixes
6. **006_add_audit_log_identifying_columns.py** - Audit log enhancements
7. **007_add_device_session_columns.py** - Device session improvements

Each migration includes:
- **Tags**: Logical grouping (e.g., `categories`, `orders`, `audit`)
- **Revision ID**: Unique identifier
- **Upgrade/Downgrade**: Forward and rollback operations

## Running Migrations

### Automatic (Default)
Migrations run automatically on application startup. No action needed.

### Manual Commands

```bash
# Upgrade to latest
alembic upgrade head

# Upgrade to specific revision
alembic upgrade 007_device_sessions

# Show current revision
alembic current

# Show migration history
alembic history

# Rollback one revision
alembic downgrade -1

# Rollback to specific revision
alembic downgrade 003_member_fields
```

## Creating New Migrations

### Auto-generate (Recommended)
```bash
# After modifying models, auto-generate migration
alembic revision --autogenerate -m "add_user_preferences"

# With tags
alembic revision --autogenerate -m "add_user_preferences" --tag=users
```

### Manual
```bash
# Create empty migration template
alembic revision -m "add_custom_index"
```

Then edit the generated file in `alembic/versions/`.

## Migration Tags

Tags help organize migrations:
- `schema` - Base schema
- `categories` - Category features
- `products` - Product features
- `members` - Member features
- `orders` - Order features
- `status_tracking` - Status tracking
- `foreign_keys` - Constraint changes
- `audit` - Audit logging
- `sessions` - Session management
- `authentication` - Auth features

## Files Changed

### New Files
- `alembic.ini` - Alembic configuration
- `alembic/env.py` - Migration environment
- `alembic/script.py.mako` - Migration template
- `alembic/versions/*.py` - Migration scripts
- `alembic/README.md` - Alembic documentation
- `alembic_runner.py` - Programmatic migration runner
- `MIGRATION_GUIDE.md` - This file

### Modified Files
- `main.py` - Now uses `alembic_runner.run_migrations()` instead of `database_migrations.run_startup_migrations()`
- `requirements.txt` - Added `alembic` dependency
- `database_migrations.py` - Marked as deprecated (kept for reference)

## Backward Compatibility

- ✅ All existing functionality preserved
- ✅ `database_migrations.py` kept for reference (deprecated)
- ✅ No breaking changes to application code
- ✅ Migrations are idempotent (safe to run multiple times)

## Troubleshooting

### Migration Fails
1. Check database connection in `.env`
2. Verify model imports in `alembic/env.py`
3. Check for conflicting migrations: `alembic history`
4. Review error logs

### Migration Already Applied
If migration shows as applied but changes aren't present:
```bash
# Use with caution - stamps database without running migration
alembic stamp head
```

### Need to Rollback
```bash
# Rollback to previous revision
alembic downgrade -1

# Rollback to specific revision
alembic downgrade 003_member_fields
```

## Best Practices

1. **Test migrations** on development database first
2. **Keep migrations small** - one logical change per migration
3. **Use descriptive names** - clear migration descriptions
4. **Include data migrations** when schema changes require data backfilling
5. **Test downgrade paths** - ensure migrations can be rolled back
6. **Review autogenerated code** - always review and adjust

## Next Steps

1. Install Alembic: `pip install -r requirements.txt`
2. Migrations will run automatically on next startup
3. For new schema changes, use `alembic revision --autogenerate`

## Support

For Alembic documentation, see: https://alembic.sqlalchemy.org/

For project-specific migration questions, see `alembic/README.md`

